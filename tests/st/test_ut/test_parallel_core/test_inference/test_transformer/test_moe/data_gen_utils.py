# Copyright 2025 Huawei Technologies Co., Ltd
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ============================================================================
"""Generate data for mcore MOE UT of inference."""
import numpy as np

def get_init_params(seq_len, batch_size, hidden_size, num_experts, moe_intermediate_size):
    """Generate initialization parameters"""
    np.random.seed(2025)
    gate_weight_shape = (num_experts, hidden_size)
    gate_e_score_correction_bias_shape = (num_experts,)
    experts_fc1_weight_shape = (num_experts, hidden_size, moe_intermediate_size * 2)
    experts_fc2_weight_shape = (num_experts, moe_intermediate_size, hidden_size)
    shared_experts_fc1_weight_shape = (moe_intermediate_size * 2, hidden_size)
    shared_experts_fc2_weight_shape = (hidden_size, moe_intermediate_size)
    return {
        "input": np.random.rand(batch_size * seq_len, hidden_size),
        "router.weight.weight": 0.01 * np.random.rand(*gate_weight_shape),
        "router.expert_bias": 0.01 * np.random.rand(*gate_e_score_correction_bias_shape),
        "experts.weight1": 0.01 * np.random.rand(*experts_fc1_weight_shape),
        "experts.weight2": 0.01 * np.random.rand(*experts_fc2_weight_shape),
        "shared_experts.linear_fc1.weight": 0.01 * np.random.rand(*shared_experts_fc1_weight_shape),
        "shared_experts.linear_fc2.weight": 0.01 * np.random.rand(*shared_experts_fc2_weight_shape),
    }

def get_golden() -> dict[str, np.ndarray]:
    """Generate golden data for test."""
    tp1 = np.array(
        [[0.00056458, 0.00054932, 0.00055695, 0.00060272, 0.00041199, 0.0005722,
          0.0005455, 0.00062561, 0.00063705, 0.00059128, 0.00056458, 0.00044823,
          0.00064468, 0.00042534, 0.00058365, 0.00062561, 0.00043869, 0.00060272,
          0.00060272, 0.00065231, 0.00050735, 0.00064087, 0.00062561, 0.0006485,
          0.00065613, 0.00047684, 0.00061035, 0.00058746, 0.00054169, 0.0005188,
          0.00048447, 0.00052261],
         [0.00056458, 0.00065994, 0.00058746, 0.00061417, 0.00052643, 0.00056458,
          0.00057983, 0.00052261, 0.00055695, 0.00063705, 0.00066757, 0.00056458,
          0.00069427, 0.00059128, 0.00071335, 0.00061798, 0.00049973, 0.00065231,
          0.00063324, 0.00078583, 0.00056458, 0.00069046, 0.00073242, 0.0005722,
          0.00072479, 0.00061035, 0.0006485, 0.00064087, 0.00059509, 0.00061417,
          0.00057602, 0.00059128],
         [0.00030708, 0.0003643, 0.00032806, 0.00033188, 0.00029182, 0.0003109,
          0.00032043, 0.00028229, 0.00030136, 0.00036049, 0.00036621, 0.00030518,
          0.00036812, 0.00032616, 0.00038719, 0.00034332, 0.00027847, 0.00035095,
          0.00034904, 0.00042915, 0.00031471, 0.00037384, 0.00039673, 0.00031281,
          0.00040436, 0.00033379, 0.00035667, 0.00033951, 0.00032425, 0.00033569,
          0.00031281, 0.0003109,],
         [0.00032425, 0.00038528, 0.00035858, 0.0003624, 0.00035095, 0.00033569,
          0.00035095, 0.00025558, 0.00032425, 0.00037766, 0.00042725, 0.00038338,
          0.00038147, 0.00039864, 0.00042534, 0.00032425, 0.00030899, 0.00035286,
          0.00033569, 0.00046158, 0.00030899, 0.00038528, 0.00045395, 0.00039864,
          0.00035667, 0.00040054, 0.00039673, 0.00040436, 0.00038147, 0.00037384,
          0.00031853, 0.00037766]], dtype=np.float32
    )

    tp1_no_shared = np.array(
        [[0.00042152, 0.00036621, 0.00037956, 0.00041199, 0.0002861, 0.00039864,
          0.00037575, 0.00049591, 0.00049591, 0.00045395, 0.0003891, 0.00032043,
          0.00044632, 0.0003109, 0.0004158, 0.00039673, 0.00028229, 0.00046921,
          0.00044823, 0.00043488, 0.00038528, 0.00043106, 0.00043869, 0.00047112,
          0.00047112, 0.00035286, 0.0004406, 0.00037956, 0.00034332, 0.00036621,
          0.00032806, 0.00037003],
         [0.00040817, 0.00044632, 0.00037956, 0.00038528, 0.00037956, 0.00036812,
          0.00038528, 0.00037384, 0.00038147, 0.00048256, 0.00046921, 0.00041389,
          0.00046539, 0.00045395, 0.00051498, 0.00035286, 0.00032425, 0.00049973,
          0.0004425, 0.00053024, 0.00042343, 0.0004406, 0.00051117, 0.0003624,
          0.00050735, 0.00046921, 0.00045776, 0.00039673, 0.0003624, 0.00043488,
          0.00038528, 0.00040436],
         [0.00021935, 0.00024796, 0.00021744, 0.00020981, 0.00021362, 0.00020504,
          0.00021553, 0.00020218, 0.00020981, 0.00027466, 0.00025749, 0.00022316,
          0.00024605, 0.00025368, 0.00028229, 0.00020027, 0.0001812, 0.00027084,
          0.00024986, 0.00029182, 0.00023937, 0.00024128, 0.00028038, 0.00020123,
          0.00028801, 0.00025749, 0.00025368, 0.00020981, 0.00020123, 0.00024319,
          0.00021076, 0.00021648],
         [0.00022793, 0.00025749, 0.0002327, 0.00022316, 0.00026321, 0.00021458,
          0.0002327, 0.00016308, 0.00022125, 0.00028229, 0.00030518, 0.00029373,
          0.00024223, 0.00031662, 0.00030708, 0.00016403, 0.00020027, 0.0002594,
          0.00022221, 0.00030899, 0.00022316, 0.00023556, 0.00032234, 0.00027275,
          0.00022411, 0.00031471, 0.00027847, 0.00025749, 0.00024033, 0.00026894,
          0.00020218, 0.00026894]]
    )

    tp2 = np.array(
        [[0.00056458, 0.00054932, 0.00055695, 0.00060272, 0.00041389, 0.0005722,
          0.0005455, 0.00062561, 0.00063705, 0.00059128, 0.00056458, 0.00044823,
          0.00064468, 0.00042725, 0.00058746, 0.00062561, 0.00043869, 0.00060272,
          0.00060272, 0.00065231, 0.00050735, 0.00063705, 0.00062561, 0.0006485,
          0.00065231, 0.00047684, 0.00060654, 0.00058746, 0.00054169, 0.0005188,
          0.00048447, 0.00052261],
         [0.00056458, 0.00065613, 0.00058746, 0.00061417, 0.00052643, 0.00056458,
          0.00057983, 0.00052261, 0.00055695, 0.00063705, 0.00066757, 0.00056458,
          0.00069427, 0.00059128, 0.00070953, 0.00061798, 0.00049973, 0.0006485,
          0.00063324, 0.00078964, 0.00056839, 0.00068665, 0.00073242, 0.0005722,
          0.00072479, 0.00061035, 0.0006485, 0.00064087, 0.00059509, 0.00061417,
          0.00057602, 0.00059128],
         [0.00030708, 0.0003624, 0.00032806, 0.00033379, 0.00029182, 0.0003109,
          0.00032043, 0.00028229, 0.00030136, 0.00036049, 0.0003624, 0.00030518,
          0.00036812, 0.00032806, 0.00038719, 0.00034332, 0.00027847, 0.00035095,
          0.00034904, 0.00042915, 0.00031662, 0.00037575, 0.00039673, 0.00031281,
          0.00040436, 0.00033569, 0.00035477, 0.00033951, 0.00032234, 0.00033569,
          0.00031281, 0.0003109],
         [0.00032425, 0.00038528, 0.00035858, 0.00036049, 0.00035095, 0.00033569,
          0.00035095, 0.00025558, 0.00032425, 0.00037766, 0.00042725, 0.00038338,
          0.00038147, 0.00039864, 0.00042725, 0.00032425, 0.00030899, 0.00035286,
          0.00033569, 0.00046158, 0.00030708, 0.00038528, 0.00045013, 0.00039673,
          0.00035667, 0.00039864, 0.00039673, 0.00040436, 0.00038147, 0.00037575,
          0.00031662, 0.00037766]]
    )

    tp2_no_shared = np.array(
        [[0.00042152, 0.00036621, 0.00037766, 0.00041199, 0.0002861, 0.00039864,
          0.00037575, 0.00049591, 0.00049591, 0.00045395, 0.0003891, 0.00032043,
          0.00044632, 0.0003109, 0.0004158, 0.00039673, 0.00028229, 0.00046921,
          0.00044823, 0.00043488, 0.00038528, 0.00042915, 0.00043869, 0.00046921,
          0.00046921, 0.00035286, 0.00043869, 0.00038147, 0.00034332, 0.00036812,
          0.00032806, 0.00037003],
         [0.00041008, 0.00044632, 0.00037956, 0.00038528, 0.00037956, 0.00036812,
          0.00038528, 0.00037384, 0.00038147, 0.00048065, 0.00046921, 0.00041199,
          0.00046539, 0.00045395, 0.00051117, 0.00035477, 0.00032425, 0.00049591,
          0.0004425, 0.00053406, 0.00042534, 0.00043869, 0.00051117, 0.0003624,
          0.00050735, 0.00046921, 0.00045776, 0.00039673, 0.0003624, 0.00043488,
          0.00038528, 0.00040436],
         [0.00021935, 0.00024796, 0.00021648, 0.00020981, 0.00021362, 0.00020504,
          0.00021553, 0.00020218, 0.00020981, 0.00027466, 0.00025558, 0.00022316,
          0.00024605, 0.00025558, 0.00028229, 0.00020027, 0.0001812, 0.00027084,
          0.00024986, 0.00029182, 0.00023937, 0.00024223, 0.00028038, 0.00020123,
          0.00028801, 0.0002594, 0.00025177, 0.00020981, 0.00020027, 0.00024319,
          0.00020981, 0.00021553],
         [0.00022793, 0.00025749, 0.00023174, 0.00022316, 0.00026321, 0.00021458,
          0.0002327, 0.00016308, 0.00022221, 0.00028229, 0.00030518, 0.00029373,
          0.00024223, 0.00031662, 0.00030899, 0.00016403, 0.00020027, 0.0002594,
          0.00022221, 0.00030899, 0.00022221, 0.00023556, 0.00032043, 0.00027084,
          0.00022411, 0.00031281, 0.00027847, 0.00025749, 0.00024033, 0.00027084,
          0.00020218, 0.00026894]]
    )

    return {
        "tp1": tp1,
        "tp2": tp2,
        "tp2_no_shared": tp2_no_shared,
        "tp1_no_shared": tp1_no_shared,
    }


def get_gpu_data() -> dict[str, np.ndarray]:
    """Generate gpu data for test."""
    tp1 = np.array(
        [[0.00056458, 0.00054932, 0.00055695, 0.00060272, 0.00041199, 0.0005722,
          0.0005455, 0.00062561, 0.00063705, 0.00059128, 0.00056458, 0.00044823,
          0.00064468, 0.00042534, 0.00058365, 0.00062561, 0.00043869, 0.00060272,
          0.00060272, 0.00065231, 0.00050735, 0.00064087, 0.00062561, 0.0006485,
          0.00065613, 0.00047684, 0.00061035, 0.00058746, 0.00054169, 0.0005188,
          0.00048447, 0.00052261],
         [0.00056458, 0.00065994, 0.00058746, 0.00061417, 0.00052643, 0.00056458,
          0.00057983, 0.00052261, 0.00055695, 0.00063705, 0.00066757, 0.00056458,
          0.00069427, 0.00059128, 0.00071335, 0.00061798, 0.00049973, 0.00065231,
          0.00063324, 0.00078583, 0.00056458, 0.00069046, 0.00073242, 0.0005722,
          0.00072479, 0.00061035, 0.0006485, 0.00064087, 0.00059509, 0.00061417,
          0.00057602, 0.00059128],
         [0.00030708, 0.0003643, 0.00032806, 0.00033188, 0.00029182, 0.0003109,
          0.00032043, 0.00028229, 0.00030136, 0.00036049, 0.00036621, 0.00030518,
          0.00036812, 0.00032616, 0.00038719, 0.00034332, 0.00027847, 0.00035095,
          0.00034904, 0.00042915, 0.00031471, 0.00037384, 0.00039673, 0.00031281,
          0.00040436, 0.00033379, 0.00035667, 0.00033951, 0.00032425, 0.00033569,
          0.00031281, 0.0003109,],
         [0.00032425, 0.00038528, 0.00035858, 0.0003624, 0.00035095, 0.00033569,
          0.00035095, 0.00025558, 0.00032425, 0.00037766, 0.00042725, 0.00038338,
          0.00038147, 0.00039864, 0.00042534, 0.00032425, 0.00030899, 0.00035286,
          0.00033569, 0.00046158, 0.00030899, 0.00038528, 0.00045395, 0.00039864,
          0.00035667, 0.00040054, 0.00039673, 0.00040436, 0.00038147, 0.00037384,
          0.00031853, 0.00037766]], dtype=np.float32
    )

    tp1_no_shared = np.array(
        [[0.00042152, 0.00036621, 0.00037956, 0.00041199, 0.0002861, 0.00039864,
          0.00037575, 0.00049591, 0.00049591, 0.00045395, 0.0003891, 0.00032043,
          0.00044632, 0.0003109, 0.0004158, 0.00039673, 0.00028229, 0.00046921,
          0.00044823, 0.00043488, 0.00038528, 0.00043106, 0.00043869, 0.00047112,
          0.00047112, 0.00035286, 0.0004406, 0.00037956, 0.00034332, 0.00036621,
          0.00032806, 0.00037003],
         [0.00040817, 0.00044632, 0.00037956, 0.00038528, 0.00037956, 0.00036812,
          0.00038528, 0.00037384, 0.00038147, 0.00048256, 0.00046921, 0.00041389,
          0.00046539, 0.00045395, 0.00051498, 0.00035286, 0.00032425, 0.00049973,
          0.0004425, 0.00053024, 0.00042343, 0.0004406, 0.00051117, 0.0003624,
          0.00050735, 0.00046921, 0.00045776, 0.00039673, 0.0003624, 0.00043488,
          0.00038528, 0.00040436],
         [0.00021935, 0.00024796, 0.00021744, 0.00020981, 0.00021362, 0.00020504,
          0.00021553, 0.00020218, 0.00020981, 0.00027466, 0.00025749, 0.00022316,
          0.00024605, 0.00025368, 0.00028229, 0.00020027, 0.0001812, 0.00027084,
          0.00024986, 0.00029182, 0.00023937, 0.00024128, 0.00028038, 0.00020123,
          0.00028801, 0.00025749, 0.00025368, 0.00020981, 0.00020123, 0.00024319,
          0.00021076, 0.00021648],
         [0.00022793, 0.00025749, 0.0002327, 0.00022316, 0.00026321, 0.00021458,
          0.0002327, 0.00016308, 0.00022125, 0.00028229, 0.00030518, 0.00029373,
          0.00024223, 0.00031662, 0.00030708, 0.00016403, 0.00020027, 0.0002594,
          0.00022221, 0.00030899, 0.00022316, 0.00023556, 0.00032234, 0.00027275,
          0.00022411, 0.00031471, 0.00027847, 0.00025749, 0.00024033, 0.00026894,
          0.00020218, 0.00026894]]
    )

    tp2 = np.array(
        [[0.00056458, 0.00054932, 0.00055695, 0.00060272, 0.00041389, 0.0005722,
          0.0005455, 0.00062561, 0.00063705, 0.00059128, 0.00056458, 0.00044823,
          0.00064468, 0.00042725, 0.00058746, 0.00062561, 0.00043869, 0.00060272,
          0.00060272, 0.00065231, 0.00050735, 0.00063705, 0.00062561, 0.0006485,
          0.00065231, 0.00047684, 0.00060654, 0.00058746, 0.00054169, 0.0005188,
          0.00048447, 0.00052261],
         [0.00056458, 0.00065613, 0.00058746, 0.00061417, 0.00052643, 0.00056458,
          0.00057983, 0.00052261, 0.00055695, 0.00063705, 0.00066757, 0.00056458,
          0.00069427, 0.00059128, 0.00070953, 0.00061798, 0.00049973, 0.0006485,
          0.00063324, 0.00078964, 0.00056839, 0.00068665, 0.00073242, 0.0005722,
          0.00072479, 0.00061035, 0.0006485, 0.00064087, 0.00059509, 0.00061417,
          0.00057602, 0.00059128],
         [0.00030708, 0.0003624, 0.00032806, 0.00033379, 0.00029182, 0.0003109,
          0.00032043, 0.00028229, 0.00030136, 0.00036049, 0.0003624, 0.00030518,
          0.00036812, 0.00032806, 0.00038719, 0.00034332, 0.00027847, 0.00035095,
          0.00034904, 0.00042915, 0.00031662, 0.00037575, 0.00039673, 0.00031281,
          0.00040436, 0.00033569, 0.00035477, 0.00033951, 0.00032234, 0.00033569,
          0.00031281, 0.0003109],
         [0.00032425, 0.00038528, 0.00035858, 0.00036049, 0.00035095, 0.00033569,
          0.00035095, 0.00025558, 0.00032425, 0.00037766, 0.00042725, 0.00038338,
          0.00038147, 0.00039864, 0.00042725, 0.00032425, 0.00030899, 0.00035286,
          0.00033569, 0.00046158, 0.00030708, 0.00038528, 0.00045013, 0.00039673,
          0.00035667, 0.00039864, 0.00039673, 0.00040436, 0.00038147, 0.00037575,
          0.00031662, 0.00037766]]
    )

    tp2_no_shared = np.array(
        [[0.00042152, 0.00036621, 0.00037766, 0.00041199, 0.0002861, 0.00039864,
          0.00037575, 0.00049591, 0.00049591, 0.00045395, 0.0003891, 0.00032043,
          0.00044632, 0.0003109, 0.0004158, 0.00039673, 0.00028229, 0.00046921,
          0.00044823, 0.00043488, 0.00038528, 0.00042915, 0.00043869, 0.00046921,
          0.00046921, 0.00035286, 0.00043869, 0.00038147, 0.00034332, 0.00036812,
          0.00032806, 0.00037003],
         [0.00041008, 0.00044632, 0.00037956, 0.00038528, 0.00037956, 0.00036812,
          0.00038528, 0.00037384, 0.00038147, 0.00048065, 0.00046921, 0.00041199,
          0.00046539, 0.00045395, 0.00051117, 0.00035477, 0.00032425, 0.00049591,
          0.0004425, 0.00053406, 0.00042534, 0.00043869, 0.00051117, 0.0003624,
          0.00050735, 0.00046921, 0.00045776, 0.00039673, 0.0003624, 0.00043488,
          0.00038528, 0.00040436],
         [0.00021935, 0.00024796, 0.00021648, 0.00020981, 0.00021362, 0.00020504,
          0.00021553, 0.00020218, 0.00020981, 0.00027466, 0.00025558, 0.00022316,
          0.00024605, 0.00025558, 0.00028229, 0.00020027, 0.0001812, 0.00027084,
          0.00024986, 0.00029182, 0.00023937, 0.00024223, 0.00028038, 0.00020123,
          0.00028801, 0.0002594, 0.00025177, 0.00020981, 0.00020027, 0.00024319,
          0.00020981, 0.00021553],
         [0.00022793, 0.00025749, 0.00023174, 0.00022316, 0.00026321, 0.00021458,
          0.0002327, 0.00016308, 0.00022221, 0.00028229, 0.00030518, 0.00029373,
          0.00024223, 0.00031662, 0.00030899, 0.00016403, 0.00020027, 0.0002594,
          0.00022221, 0.00030899, 0.00022221, 0.00023556, 0.00032043, 0.00027084,
          0.00022411, 0.00031281, 0.00027847, 0.00025749, 0.00024033, 0.00027084,
          0.00020218, 0.00026894]]
    )

    return {
        "tp1": tp1,
        "tp2": tp2,
        "tp2_no_shared": tp2_no_shared,
        "tp1_no_shared": tp1_no_shared,
    }


GOLDEN_DATA = get_golden()
GPU_DATA = get_gpu_data()
